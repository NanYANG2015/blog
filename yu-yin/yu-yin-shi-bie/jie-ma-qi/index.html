<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="解码器, 梦园">
    <meta name="description" content="1.  参数

beam: 每一帧保留的token的cost 与当前帧最优cost的最大允许差值。越大，解码越慢，内存占用越大，但越准确。默认值16.0（即路径概率约为1.1e-07 = 1/exp(16) 倍）。
max_active: ">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    

    <title>解码器 | 梦园</title>
    <link rel="icon" type="image/png" href="/blog/favicon.png">

    <link rel="stylesheet" type="text/css" href="/blog/libs/awesome/css/all.min.css">
    <link rel="stylesheet" type="text/css" href="/blog/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/blog/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/blog/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/blog/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/blog/css/my.css">

    <script src="/blog/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.1.0"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">梦园</div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/blog/" class="waves-effect waves-light">
      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/blog/categories" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/blog/about">
          
          <i class="fas fa-user-circle" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>我</span>
        </a>
      </li>
      
      <li>
        <a href="/blog/words">
          
          <i class="fas fa-pen" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>文字</span>
        </a>
      </li>
      
      <li>
        <a href="/blog/books">
          
          <i class="fas fa-book" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>书</span>
        </a>
      </li>
      
      <li>
        <a href="/blog/videos">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>视频</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/blog/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">梦园</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/blog/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-list"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/blog/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-user-circle"></i>
			
			关于
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/blog/about " style="margin-left:50px">
				  
				   <i class="fa fas fa-user-circle" style="position: absolute;left:28px" ></i>
			      
		          <span>我</span>
                  </a>
                </li>
              
                <li>

                  <a href="/blog/words " style="margin-left:50px">
				  
				   <i class="fa fas fa-pen" style="position: absolute;left:28px" ></i>
			      
		          <span>文字</span>
                  </a>
                </li>
              
                <li>

                  <a href="/blog/books " style="margin-left:50px">
				  
				   <i class="fa fas fa-book" style="position: absolute;left:28px" ></i>
			      
		          <span>书</span>
                  </a>
                </li>
              
                <li>

                  <a href="/blog/videos " style="margin-left:50px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:28px" ></i>
			      
		          <span>视频</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    
<script src="/blog/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/blog/';
            }
        }
    })();
</script>


<div class="bg-cover pd-header about-cover">
    <div class="container">
    <div class="row">
    <div class="col s10 offset-s1 m8 offset-m2 l8">
        <div class="brand">
            <div class="title">
                
                愿，彼此相伴，走过流年
                
            </div>
        </div>
    </div>
</div>

    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/blog/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 200px);
        overflow: scroll;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="pd-header post-cover">
                <div class="container" style="right: 0px;left: 0px;">
                    <div class="row">
                        <div class="col s12 m12 l12">
                            <div class="brand">
                                <h1 class="description center-align post-title">解码器</h1>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row tag-cate">
                <div class="right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/blog/categories/%E8%AF%AD%E9%9F%B3/" class="post-category">
                                语音
                            </a>
                        
                            <a href="/blog/categories/%E8%AF%AD%E9%9F%B3/%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/" class="post-category">
                                语音识别
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-05-03
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-07-03
                </div>
                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/blog/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="参数">1.  参数</h1>
<ul>
<li>beam: 每一帧保留的token的cost 与当前帧最优cost的最大允许差值。越大，解码越慢，内存占用越大，但越准确。默认值16.0<font color="green">（即路径概率约为1.1e-07 = 1/exp(16) 倍）</font>。</li>
<li>max_active: 每一帧可以激活的最大状态数。越大，解码越慢，内存占用越大，但越准确。默认值7000。</li>
<li>min_active: 每一帧需要激活的最小状态数。默认值200。</li>
<li><a href="#lattice_beam">lattice_beam</a>: Lattice Decoder中，跳转弧到达当前最后一帧active token A的最优路径的cost与到达A的最优路径的cost的最大允许差值（对于当前最后一帧的多个active tokens，其一满足即可）。默认值6.0<font color="green">（即路径概率约为0.0025 = 1/exp(6) 倍）</font>。</li>
<li><a href="#beam_delta">beam_delta</a>: FasterDecoder中，用于根据前一帧估计当前帧的<code>adaptive_beam</code>。默认值0.5。</li>
<li>prune_interval: Lattice Decoder中，每隔多少帧裁剪过去帧的tokens。默认值20。</li>
<li><a href="#prune_scale">prune_scale</a>: Lattice Decoder中，若token的extra cost变大（假设上一次PruneActiveTokens时，该token计算extra cost对应的是当时最后一帧的token A，当A不在到达当前最后一帧的最佳路径上时，该token的extra cost就会变大）超过<code>lattice_beam * prune_scale</code>，则需要判断之前的帧是否需要裁剪。越大，则向前回溯得越少（内存与解码速度的均衡）。默认值0.1。</li>
<li><a href="#hash_ratio">hash_ratio</a>：FasterDecoder中，用于设置存储tokens的哈希表的容量。默认值2。</li>
<li>length_penalty：LatticeFasterDecoder中，每跳转到一个新的状态（排除了状态自旋、epsilon弧），graph cost加上length_penalty。&gt;0则倾向于短句子，&lt;0时倾向于长句子。默认值0.0。</li>
</ul>
<h1 id="数据结构">2.  数据结构</h1>
<ul>
<li>DecodableInterface: 为了最小化解码器和声学模型代码之间的交互，创建了该基类。DecodableInterface 对象可以视为LogLikelihood矩阵。
<ul>
<li>BaseFloat LogLikelihood(int32 frame, int32 index): 返回索引(frame, index)对应的声学log-likelihood。若已计算，则直接返回值；否则调用声学模型计算。可能还包含减log_priors、乘acoustic_scale等处理。
<ul>
<li>acoustic_scale：默认值0.1。</li>
</ul>
</li>
<li>int32 NumFramesReady(): 根据已计算的声学特征，可得到的LogLikelihood帧数（声学模型可能包含降采样、特征上下文等处理）。</li>
<li>bool IsLastFrame(int32 frame): 是否为最后一帧（若为online模式，则须输入结束）。</li>
</ul>
</li>
<li>Decoder
<ul>
<li>构造decoder需要传入fst和相关配置参数。</li>
</ul>
</li>
<li>Token（以下主要以Lattice Decoder为例）
<ul>
<li>每一帧、每个激活的状态各由一个Token表示。</li>
<li>BaseFloat tot_cost: 从句子开头到当前状态的AM + LM cost (ac_cost + graph_cost)。
<ul>
<li>vector&lt;BaseFloat&gt; cost_offsets_: 每一帧，AM log-likelihoods 加的 offset，使其接近0，减小roundoff的误差。</li>
</ul>
</li>
<li>BaseFloat extra_cost: 认为当前最后一帧的各active token都有可能在最终的最优路径上，extra_cost均为0；其它帧token的extra cost为：经过该token到达当前最后一帧active token（计为A）的最优路径，与到达A的最优路径的cost差值；对于当前最后一帧的多个active tokens，取这些cost差值的最小值。在PruneForwardLinks(Final)中计算。</li>
<li>ForwardLink<stdtoken> *links: 该token到下一帧的跳转弧（或跳转到当前帧的epsilon弧）的单链表
<ul>
<li>fst::StdArc::Label ilabel</li>
<li>fst::StdArc::Label olabel</li>
<li>BaseFloat acoustic_cost: cost_offset - logLikelihood</li>
<li>BaseFloat graph_cost: arc.weight，包含状态转移模型概率、词典发音概率、静音概率、LM概率等</li>
<li>Token *next_tok：跳转到的下一个token</li>
<li>ForwardLink *next：单链表结构</li>
</ul>
</stdtoken></li>
<li>Token *next: 该帧的下一token</li>
<li>非Lattice Decoder中还包含：
<ul>
<li>int32 ref_count_: 该token跳转到的token的数量+1。当该token不再在到达当前最后一帧的各active token的最优路径上时，删除该token。</li>
<li>Token *prev_: 路径中的上一个token，用于回溯。
<ul>
<li>Lattice Decoder记录路径中的下一token，<font color="green">更高效</font>。GetBestPath中，先顺序遍历每一帧的active tokens 生成lattice，再采用 openfst 的 ShortestPath 返回最优路径。</li>
</ul>
</li>
<li>arc_.nextstate 当前状态</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="解码器类型">3.  解码器类型</h1>
<h2 id="simpledecoder">3.1.  SimpleDecoder</h2>
<ul>
<li>采用<code>unordered_map&lt;StateId, Token*&gt; cur_toks_, prev_toks_</code> 分别存储当前帧和前一帧的active tokens。</li>
<li>Viterbi beam search。</li>
</ul>
<p>核心流程如下：</p>
<pre class="line-numbers language-none"><code class="language-none">InitDecoding();
while (num_frames_decoded_ &lt; target_frames_decoded) &#123;
    &#x2F;&#x2F; note: ProcessEmitting() increments num_frames_decoded_
    ClearToks(prev_toks_);  &#x2F;&#x2F; 删除历史无用路径，并清空prev_toks_
    cur_toks_.swap(prev_toks_);
    ProcessEmitting(decodable);  &#x2F;&#x2F; 处理发射弧，将token从上一帧传播到当前帧
    ProcessNonemitting();  &#x2F;&#x2F; 处理当前帧token的epsilon弧
    PruneToks(beam_, &amp;cur_toks_);  &#x2F;&#x2F; 再次裁剪（因为ProcessEmitting中的cutoff是动态更新的）
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="fasterdecoder">3.2.  FasterDecoder</h2>
<ul>
<li>采用<code>HashList&lt;StateId, Token*&gt; toks_</code> 存储tokens，其元素可以通过哈希表访问，也可以通过单链表访问。token传播时，先清空哈希表，前一帧的active tokens仅可以通过单链表访问，当前帧的active tokens还可以通过哈希表访问。
<ul>
<li>创建新token时，需要查询对应的状态是否已存在token，相较于unordered_map的遍历查找，采用哈希表查找速度更快。</li>
</ul>
</li>
<li>采用<code>max-active</code>、<code>min-active</code> 调整裁剪。</li>
</ul>
<p>核心流程如下：</p>
<pre class="line-numbers language-none"><code class="language-none">InitDecoding();
while (num_frames_decoded_ &lt; target_frames_decoded) &#123;
    double weight_cutoff &#x3D; ProcessEmitting(decodable);
    ProcessNonemitting(weight_cutoff);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="biglmfasterdecoder">3.3.  BiglmFasterDecoder</h2>
<ul>
<li>大语言模型：弧数&gt;百万。由于内存限制，很难构建解码图。</li>
<li><font color="red"> 两种处理方式 </font>
<ul>
<li>先采用小LM生成lattice，再用大LM对lattice进行rescore。（小、大指ngram阶数）</li>
<li>采用“biglm” decoder：先采用小LM <code>G</code> 构建HCLG，解码时动态地compose 大LM <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>G</mi><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">G^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span> 与小LM的差。<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>H</mi><mi>C</mi><mi>L</mi><mi>G</mi><mo>∘</mo><msup><mi>G</mi><mo>−</mo></msup><mo>∘</mo><msup><mi>G</mi><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">HCLG \circ G^{-} \circ G^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">L</span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.771331em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>G</mi><mo>−</mo></msup></mrow><annotation encoding="application/x-tex">G^{-}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.771331em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span></span></span></span> 为对<code>G</code>中的权重取负数得到。
<ul>
<li>实现：未采用通用的compose算法，而是采用 <span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo stretchy="false">(</mo><mi>H</mi><mi>C</mi><mi>L</mi><mi>G</mi><mi mathvariant="normal">中</mi><mi mathvariant="normal">的</mi><mi mathvariant="normal">状</mi><mi mathvariant="normal">态</mi><mo separator="true">,</mo><msup><mi>G</mi><mo>−</mo></msup><mo>∘</mo><msup><mi>G</mi><mo mathvariant="normal">′</mo></msup><mi mathvariant="normal">中</mi><mi mathvariant="normal">的</mi><mi mathvariant="normal">状</mi><mi mathvariant="normal">态</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(HCLG中的状态, G^{-} \circ G^{\prime}中的状态)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.021331em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right:0.08125em;">H</span><span class="mord mathdefault" style="margin-right:0.07153em;">C</span><span class="mord mathdefault">L</span><span class="mord mathdefault">G</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">状</span><span class="mord cjk_fallback">态</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∘</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:1.001892em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">状</span><span class="mord cjk_fallback">态</span><span class="mclose">)</span></span></span></span> 状态空间，查找指定状态上具有指定输入标签的弧。</li>
<li>缺点：解码较慢。<font color="green"> 相较于beam相同、但没有biglm部分的解码器，biglm decoder 耗时几乎为2倍 (疑问：对比时，普通解码器LM大小与biglm decoder中的<code>G</code>相当，还是与<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mi>G</mi><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">G^{\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord"><span class="mord mathdefault">G</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>相当？)</font>。</li>
</ul>
</li>
<li>效果：大语言模型的HCLG &gt; biglm decoder &gt; rescore。
<ul>
<li>rescore：采用小LM生成lattice时最优路径有可能被裁剪掉。</li>
<li>biglm decoder：<font color="green"> only updates the ‘good’ language model score every time it crosses a word（ChatGPT: 只有在完整的单词被解码时才会更新语言模型分，可以通过减少语言模型需要被评估的次数来加速解码，但是，与在每个声学帧或每个子单元上更新语言模型分相比，可能会导致稍微不太准确的解码结果。）</font></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="lattice-decoder">3.4.  Lattice Decoder</h2>
<ul>
<li>对比
<ul>
<li>one-best解码：只保留到达active状态的最优路径。</li>
<li>lattice解码：若存在多条可行路径到达同一active状态，均保留。</li>
</ul>
</li>
<li>采用<code>vector&lt;TokenList&gt; active_toks_</code>记录每一帧的active tokens链表头节点</li>
<li>采用lattice beam进一步裁剪。</li>
</ul>
<p>核心流程如下：</p>
<pre class="line-numbers language-none"><code class="language-none">InitDecoding();
while (NumFramesDecoded() &lt; target_frames_decoded) &#123;
    if (NumFramesDecoded() % config_.prune_interval &#x3D;&#x3D; 0)
      PruneActiveTokens(config_.lattice_beam * config_.prune_scale);
    double weight_cutoff &#x3D; ProcessEmitting(decodable);
    ProcessNonemitting(weight_cutoff);
&#125;
FinalizeDecoding();  &#x2F;&#x2F; 可选，采用lattice beam进行裁剪<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="latticefasteronlinedecoder">3.5.  LatticeFasterOnlineDecoder</h2>
<ul>
<li>支持在使用endpointing或其它需要频繁获取最佳路径的场景下高效计算GetBestPath()</li>
<li>BackpointerToken: 用于高效的GetBestPath()，上一步的最佳token</li>
<li>BestPathEnd()</li>
<li>BestPathIterator</li>
</ul>
<h1 id="代码解析">4.  代码解析</h1>
<h2 id="decodablenumframesready">4.1.  Decodable::NumFramesReady()</h2>
<p>由于声学模型输入特征可能包含上下文，音频中间和末尾的NumFramesReady计算方式可能不一样</p>
<h2 id="span-idlattice_beampruneactivetokensspan">4.2.  PruneActiveTokens</h2>
<ul>
<li>
<p>通常每一帧有数千个active tokens，因此定期（prune_interval）采用lattice_beam 进行裁剪，而不是等到话语结束才裁剪。</p>
</li>
<li>
<p>逆序遍历每一帧（不包含当前帧）</p>
<ul>
<li>PruneForwardLinks
<ul>
<li>对该帧的所有token
<ul>
<li>对该token的所有link
<ul>
<li><font color="green"> <code>link_extra_cost = next_tok-&gt;extra_cost + ((tok-&gt;tot_cost + link-&gt;acoustic_cost + link-&gt;graph_cost) - next_tok-&gt;tot_cost)</code> </font></li>
<li>若<code>link_extra_cost &gt; lattice_beam</code>，删除该link</li>
<li>否则，统计<code>link_extra_cost</code>的最小值<code>tok_extra_cost</code></li>
</ul>
</li>
<li>若<code>fabs(tok_extra_cost - tok-&gt;extra_cost) &gt; delta</code>，计为changed</li>
<li>tok-&gt;extra_cost = tok_extra_cost（无穷表示所有的forward link都被裁剪了）</li>
</ul>
</li>
<li><font color="green"> 若changed，重复上述流程直到changed为false，因为不保证link是拓扑顺序 </font></li>
</ul>
</li>
<li>若<code>extra_costs_changed</code>，前一时刻<code>must_prune_forward_links</code></li>
<li>PruneTokensForFrame：删除extra_cost为无穷的token <font color="green">（调用参数：下一时刻）</font></li>
</ul>
</li>
<li>
<p>从当前帧向后扫描到开头（不包含当前帧），为每个token计算最优路径的cost与经过该token的最优路径的cost的差值delta；若delta&gt;lattice_beam，裁剪掉对应的token和link。当检测到某一帧所有token的delta值都没有改变时，停止回溯。对于非常长的语句，通常仅向后裁剪1-2s。另外，绝大多数token在该算法第一次访问时就被删除了，因此裁剪算法的时间复杂度接近线性，而不是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>T</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(T^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right:0.13889em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p>
<ul>
<li>注意事项
<ul>
<li>必须先裁剪掉前一帧的forward links，再裁剪token，从而避免“悬挂”的forward links</li>
<li>最后一帧需要特殊处理，以考虑final cost</li>
</ul>
</li>
</ul>
</li>
<li>
<p>获取best path：将确定化前的lattice转换成OpenFst结构，运行 OpenFst 的 ShortestPath 算法</p>
</li>
<li>
<p>确定化前的lattice可用于声学rescore</p>
</li>
<li>
<p>FinalizeDecoding: 进一步裁剪，采用final-probs，解码过程中的裁剪可能无法裁剪beam kPruningScale = 0.1 外的状态</p>
</li>
<li>
<p>lattice 确定化：只保留每个单词序列的最优路径。可用于计算句子级的置信度分、LM rescore。<font color="green">TODO: 具体实现 </font></p>
<pre><code>  +   cost_cutoff = ProcessEmitting(decodable)
      +   将令牌从前一帧传播到当前帧：对于前一帧的各active token，若满足不被裁剪的条件 &lt;font color=&quot;red&quot;&gt;（cur_cutoff）&lt;/font&gt;，处理其对应的状态的各发射弧（即输入标签非0 - epsilon），若满足不被裁剪的条件 &lt;font color=&quot;red&quot;&gt;（next_cutoff）&lt;/font&gt;，则创建新token，包含该前一帧的token用于回溯、该弧、该路径到当前帧的累计cost等信息。&lt;? lattice&gt;若当前帧已存在与该状态关联的token，仅保留cost最小的 &lt;&gt; 其中，next_cutoff根据当前帧的最佳cost、有效beam width（同时满足beam、max_active等条件）估计，通过前一帧的best token估计当前帧的最佳cost（若找到更好的，则更新该估计值），采用adaptive_beam表示估计的有效beam width，并加上&lt;span id=&quot;beam_delta&quot;&gt;beam_delta&lt;/span&gt;（默认值0.5），该值通常 &gt;= 实际有效的beam width，认为采用beam_delta=0.5时 该估计值比实际值更严格的情况不会经常发生。
      +   数据结构
          +   Elem *list_head_
          +   size_t bucket_list_tail_
      +   &lt;font color=&quot;green&quot;&gt; *final_toks = toks_.Clear() &lt;/font&gt;
      +   GetCutoff：计算上一帧的cutoff
          +   返回值：同时满足`beam`、`max_active`、`min_active`约束的cost临界值
          +   adaptive_beam: 若根据`max_active`或`min_active`调整了beam，则为同时满足上述约束的$beam^&#123;\prime&#125;$ + `beam_delta`，否则为`beam`。
      +   &lt;span id=&quot;hash_ratio&quot;&gt;PossiblyResizeHash(tok_cnt)：若上一帧的token数`tok_cnt` `* hash_ratio &gt; toks_.Size()`，`toks_`扩容。&lt;/span&gt;
      +   初始化当前帧的cutoff：取上一帧的best state，对其在fst上的各发射弧，计算cost，cutoff取上述cost的最小值 + adaptive_beam
      +   cost_offsets_[frame] = - best_elem-&gt;val-&gt;tot_cost
      +   对上一帧满足cutoff约束的token，遍历其state在fst上的各发射弧。若满足当前帧cutoff，创建新token、将新link添加至tok-&gt;links头部。若未传播到当前帧，删除历史无用路径。动态更新当前帧cutoff。
  +   ProcessNonemitting(cost_cutoff)
      +   对于当前帧满足cutoff约束的各token，处理其对应的状态的各非发射弧（即输入标签为0 - epsilon）。
      +   对于各state含Epsilon边的token，若满足cur_cutoff、cur_cost + graph_cost &lt; next_cutoff，创建新token、将新link添加至tok-&gt;links头部
      +   若arc.nextstate也含Epsilon边，将新token也加入处理队列（queue）
</code></pre>
</li>
</ul>
<h1 id="tokendelete">5.  TokenDelete</h1>
<p><font color="green"> 若ref_count==1，删除到达该token的路径上的所有无用token。</font></p>
<h1 id="getbestpath">6.  GetBestPath</h1>
<ul>
<li>use_final_probs: 若为true，且存在token在final状态，则仅考虑所有在final状态的token；否则，不考虑final权重，取cost最小的token。</li>
<li>最后调用RemoveEpsLocal</li>
<li>GetBestPath
<ul>
<li>GetRawLattice：根据active_toks_中每一帧的active tokens，及token间的forwardlink，生成FST</li>
<li>ShortestPath：</li>
</ul>
</li>
</ul>
<h1 id="pruneactivetokens">7.  PruneActiveTokens</h1>
<p>保留当前最后一帧的所有token，认为其均有可能走到最后(extra cost均为0)。对之前的帧，采用lattice beam 裁剪forward link。<br>
<span id="prune_scale">若当前帧存在token的extra cost变化（所需变化的幅度由delta控制，delta越大，则向前回溯得越少），则上一帧也需要裁剪forward link。</span><br>
若所有forward link均被裁剪，则裁剪该token。</p>
<h1 id="finalizedecoding">8.  FinalizeDecoding</h1>
<ul>
<li>
<p>若非“final节点”或其所在的最优路径与全局最优路径的cost差超过lattice beam，设置tok_extra_cost为无穷大。</p>
</li>
<li>
<p>若该token存在forward link（epsilon弧），若该路径与最优路径的cost差超过lattice beam，删除该forward link。</p>
</li>
<li>
<p>注意1：extra_cost初始值为0，在上述遍历active tokens时逐一计算。但是，由于token间的forward link，并且token非拓扑顺序，所以，需要循环，直到所有token的extra cost不再变化。</p>
</li>
<li>
<p>注意2：从后向前裁剪，裁剪完前一帧的forward link后，再裁剪后一帧的token，避免指针指向错误。</p>
</li>
<li>
<p>GetRawLattice</p>
</li>
<li>
<p>ShortestPath<br>
从结束状态 cost最小的token开始回溯，若is_final为true，则考虑final概率。返回线性FST，由于epsilon弧，弧数可能比帧数多。</p>
</li>
</ul>
<h1 id="疑问">9.  疑问</h1>
<ul>
<li>simple-decoder.h
<ul>
<li>ref_count: 当前token跳转到的下一帧的token数。line 103: active帧的ref_count默认为1？</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="http://faster-decoder.cc">faster-decoder.cc</a>
<ul>
<li>toks_.Delete(e); hashlist kaldi/src/util/hash-list-inl.h</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="http://lattice-simple-decoder.cc">lattice-simple-decoder.cc</a><pre class="line-numbers language-none"><code class="language-none">const int32 bucket_count &#x3D; num_toks_&#x2F;2 + 3;  # bucket_count &#x3D; num_toks_ ?
unordered_map&lt;Token*, StateId&gt; tok_map(bucket_count);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li>Lattice Decoder 与one best 解码的区别
<ul>
<li>one best解码中，每一个token存储跳转到该状态的上一token（best path,唯一）</li>
<li>lattice解码中，每一个token存储其跳转到的所有token（对某一个token，可能有到达它的多条路径）</li>
</ul>
</li>
<li><mark>LatticeSimpleDecoder、LatticeFasterDecoder、LatticeBiglmFasterDecoder</mark></li>
</ul>
<p>仅剩get lattice</p>
<h1 id="参考资源">10.  参考资源</h1>
<ul>
<li><a target="_blank" rel="noopener" href="https://kaldi-asr.org/doc/decoders.html">https://kaldi-asr.org/doc/decoders.html</a></li>
<li><a target="_blank" rel="noopener" href="https://kaldi-asr.org/doc/lattices.html">https://kaldi-asr.org/doc/lattices.html</a></li>
</ul>
<script type="text&#x2F;javascript" src="https://unpkg.com/kity@2.0.4/dist/kity.min.js"></script><script type="text&#x2F;javascript" src="https://unpkg.com/kityminder-core@1.4.50/dist/kityminder.core.min.js"></script><script defer="true" type="text&#x2F;javascript" src="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.js"></script><link rel="stylesheet" type="text&#x2F;css" href="https://unpkg.com/hexo-simple-mindmap@0.8.0/dist/mindmap.min.css">
                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <i class="fas fa-exclamation-circle"></i>
            <span>
                本文不允许转载。
            </span>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

    <article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <div class="card-title">
                    <a href="/blog/yu-yin/yu-yin-shi-bie/xu-lie-qu-fen-xing-xun-lian/"> 序列区分性训练</a>
                </div>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2022-05-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/blog/categories/%E8%AF%AD%E9%9F%B3/" class="post-category">
                                    语音
                                </a>
                            
                            <a href="/blog/categories/%E8%AF%AD%E9%9F%B3/%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/" class="post-category">
                                    语音识别
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <div class="card-title">
                    <a href="/blog/yu-yin/yu-yin-shi-bie/yu-yan-mo-xing/"> 语言模型</a>
                </div>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-05-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/blog/categories/%E8%AF%AD%E9%9F%B3/" class="post-category">
                                    语音
                                </a>
                            
                            <a href="/blog/categories/%E8%AF%AD%E9%9F%B3/%E8%AF%AD%E9%9F%B3%E8%AF%86%E5%88%AB/" class="post-category">
                                    语音识别
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('50')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE' || selection.getRangeAt(0).commonAncestorContainer.nodeName === 'CODE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 梦园<br />'
            + '文章作者: nanyang<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/blog/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/blog/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/blog/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/blog/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/blog/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('6'),
            headingSelector: 'h1, h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
    });
</script>



    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/blog/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="5001011615"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/blog/libs/aplayer/APlayer.min.js"></script>
<script src="/blog/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2023</span>
            
            <a href="/blog/about" target="_blank">nanyang</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            <br>

            <!-- 运行天数提醒. -->
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/NanYANG2015" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2271348390@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2271348390" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2271348390" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/blog/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/blog/libs/materialize/materialize.min.js"></script>
    <script src="/blog/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/blog/libs/aos/aos.js"></script>
    <script src="/blog/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/blog/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/blog/js/matery.js"></script>

    
        <!-- <script src='https://unpkg.com/mermaid@latest/dist/mermaid.min.js'></script> -->
        <script src='/blog/libs/mermaid/mermaid.min.js'></script>
        <script>
          if (window.mermaid) {
            mermaid.initialize({theme: 'neutral'});
          }
        </script>
    

    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

    
    

    

    

    <!--腾讯兔小巢-->
    
    

    

    

    
    <script src="/blog/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
